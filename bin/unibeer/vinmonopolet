#!/usr/bin/python
# This Python file uses the following encoding: utf-8

import csv, urllib2, sys, locale, sqlite3

from distutils.util import strtobool
from unicodedictreader import UnicodeDictReader

class Vinmonopolet:
	def __init__(self):
		self.conn = sqlite3.connect('unibeer.db')
		self.conn.row_factory = sqlite3.Row
		self.connection = self.conn.cursor()

	def __del__(self):
		self.conn.commit()
		self.conn.close()

	def createTables(self):
		try:
			if strtobool(raw_input("Wipe vinmonopolet? " )):
				#self.connection.execute('''DROP TABLE vinmonopolet''')
				self.connection.execute('''CREATE TABLE IF NOT EXISTS vinmonopolet (id INTEGER, imported bigint, updated bigint, name text, price real, abv real, volume real, url text)''')
				self.connection.execute('''CREATE UNIQUE INDEX IF NOT EXISTS vmp ON vinmonopolet(id)''')
			else:
				print ":)"
		except ValueError:
			print "Nada nix"

	def show(self, where=""):
		if (where != ""):
			where = " WHERE " + where
		rows = self.connection.execute("SELECT * FROM vinmonopolet" + where).fetchall()
		for row in rows:
			print row["id"], row["name"].encode('utf-8')
		if len(rows) == 0:
			print "No no nothing"	

	def count(self, where=""):
		if (where != ""):
			where = "WHERE " + where
		row = self.connection.execute("SELECT COUNT(0) num FROM vinmonopolet " + where).fetchone()
		return row["num"]

	def imp(self):
		print "Importing beers ..."
		response = urllib2.urlopen('http://www.vinmonopolet.no/api/produkter')

		products = list(UnicodeDictReader(response, delimiter=';'))

		for p in products:
			if len(p['Varetype']) == 2:
				self.connection.execute('''INSERT OR IGNORE INTO vinmonopolet (id, imported) VALUES (?,strftime('%s', 'now'))''', (int(p['Varenummer']),))
				self.connection.execute("UPDATE vinmonopolet SET updated = strftime('%s', 'now'), name = ?, price = ?, abv = ?, volume = ?, url = ? WHERE id = ?",
					(p['Varenavn'], float(p["Pris"].replace(",", ".")), float(p["Alkohol"].replace(",", ".")), float(p["Volum"].replace(",", ".")), p["Vareurl"], int(p["Varenummer"].decode('utf-8')))
				)
	def usage(self):
		print "Commands: import, shownew, showall, reset"

locale.setlocale(locale.LC_ALL, 'nb_NO.UTF-8')

vmp = Vinmonopolet()

if len(sys.argv) == 1:
	vmp.usage()
else:
	cmd = sys.argv[1]
	if cmd == "import":
		vmp.imp()
		vmp.show("imported > updated - 10")
	elif cmd == "shownew":
		vmp.show("imported > updated - 10")
	elif cmd == "showall":
		vmp.show("")
	elif cmd == "reset":
		vmp.createTables()
		vmp.imp()
		num = vmp.count("imported > updated - 10")
		print str(num) + " new beers"
	else:
		vmp.usage()