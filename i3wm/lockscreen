#!/bin/bash
SCREENWIDTH=`xrandr --current | grep '*' | uniq | awk '{print $1}' |  cut -d 'x' -f1`
SCREENHEIGHT=`xrandr --current | grep '*' | uniq | awk '{print $1}' |  cut -d 'x' -f2`
SCREENS=`xrandr --current | grep '*' | wc -l`

FILE_LOCATION=/tmp/screenshot.png

OLDURL=`cat /tmp/todaysxkcd.html | grep "Image URL" | awk '{print $NF}'`

curl -s www.xkcd.com -o /tmp/todaysxkcd.html
URL=`cat /tmp/todaysxkcd.html | grep "Image URL" | awk '{print $NF}'`
HOVERTEXT=`cat /tmp/todaysxkcd.html | sed -rn 's/.*imgs\.xkcd\.com.*comics.*title="([^"]*)".*/\1/p' | html2text`
EXT=`echo $URL | rev | cut -d '.' -f1 | rev`
XKCDFILE=/tmp/todaysxkcd.${EXT}
if [ "$OLDURL" != "$URL" ]; then
	curl -s $URL -o ${XKCDFILE}
fi
XKCDWIDTH=`identify -format '%w' ${XKCDFILE}`
XKCDHEIGHT=`identify -format '%h' ${XKCDFILE}`
LEFTPOS=`bc <<< "(${SCREENWIDTH}-${XKCDWIDTH})/2"`
TOPPOS=`bc <<< "(${SCREENHEIGHT}-${XKCDHEIGHT})/2"`

scrot $FILE_LOCATION
mogrify -scale 10% -scale 1000% $FILE_LOCATION
convert -background "rgba(0,0,0,0.50)" -fill white -gravity center -pointsize 20 -size ${XKCDWIDTH}x caption:"${HOVERTEXT}" /tmp/text.png

for i in $(seq 1 ${SCREENS}); do
	convert -composite $FILE_LOCATION ${XKCDFILE} -geometry +${LEFTPOS}+${TOPPOS} $FILE_LOCATION;
	convert -composite $FILE_LOCATION /tmp/text.png -geometry +${LEFTPOS}+`bc <<< "${TOPPOS}+${XKCDHEIGHT}+10"` $FILE_LOCATION;
	LEFTPOS=`bc <<< "${LEFTPOS}+${SCREENWIDTH}"`;
done

i3lock -i $FILE_LOCATION
